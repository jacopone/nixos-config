#!/usr/bin/env bash
set -e



echo "Git working tree is clean. Starting update..."

# Update the flake inputs
echo "--> Updating flake inputs..."
nix flake update

# Perform a test build
echo "--> Performing a test build (without activating)..."
# Use 'build' instead of 'test' to get the path to the new configuration
# and avoid the 'Failed to start transient service unit' error if not root
NEW_CONFIG_PATH=$(nix build --no-link --print-out-paths .#nixosConfigurations."nixos".config.system.build.toplevel)

echo "--> Test build successful. New configuration path: $NEW_CONFIG_PATH"

# Activate the new configuration
echo "--> Activating the new configuration..."
sudo nixos-rebuild switch --flake .

echo "--> Configuration activated. Please test the changes now."
read -p "Are you satisfied with the changes? (y/n) " -n 1 -r
echo

if [[ $REPLY =~ ^[Yy]$ ]]
then
    echo "--> Changes accepted. Staging for commit..."
    git add . # Stage all changes

    git status # Show git status before prompting for commit message

    # Ask for a commit message
    read -p "Enter a commit message for these changes (or leave blank to skip commit): " commit_message

    if [ -n "$commit_message" ]; then
      echo "--> Committing changes..."
      git commit -m "$commit_message"
    else
      echo "--> No commit message provided. Skipping commit."
    fi
else
    echo "--> Changes rejected. Rolling back to previous configuration..."
    sudo nixos-rebuild switch --rollback
    echo "--> Rollback complete. Exiting."
    exit 0 # Exit successfully after rollback
fi

# Clean up old generations
echo "--> Listing system generations..."
sudo nixos-rebuild list-generations

read -p "Enter the generations you want to delete (separated by space): " generations_to_delete
if [ -n "$generations_to_delete" ]; then
    echo "--> Deleting generations: $generations_to_delete"
    sudo nix-env -p /nix/var/nix/profiles/system --delete-generations $generations_to_delete
    echo "--> Selected generations deleted."
else
    echo "--> No generations selected for deletion."
fi

echo ""
echo "NixOS system rebuild and cleanup complete!"

read -p "Do you want to push the changes? (y/n) " -n 1 -r
echo
if [[ $REPLY =~ ^[Yy]$ ]]
then
    git push
fi