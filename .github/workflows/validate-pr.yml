---
name: Validate PR

on:
  pull_request:
    branches: [master]

concurrency:
  group: validate-${{ github.ref }}
  cancel-in-progress: true

jobs:
  syntax:
    name: Syntax & Lint
    runs-on: ubuntu-latest
    timeout-minutes: 10

    permissions:
      contents: read

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: cachix/install-nix-action@v25
        with:
          nix_path: nixpkgs=channel:nixos-unstable
          extra_nix_config: |
            trusted-public-keys = cache.nixos.org-1:6NCHdD59X431o0gWypbMrAURkbJ16ZPMQFGspcDShjY= devenv.cachix.org-1:w1cLUi8dv3hnoSPGAuibQv+f9TZLr6cv/Hm9XgU50cw=
            max-jobs = auto
            cores = 0

      - name: Setup Nix cache
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/nix
            /nix/store
          key: nix-${{ runner.os }}-${{ hashFiles('flake.lock') }}
          restore-keys: |
            nix-${{ runner.os }}-

      - name: Flake syntax check
        run: |
          echo "## Syntax Check" >> $GITHUB_STEP_SUMMARY
          nix flake check --no-build
          echo "‚úÖ Flake syntax is valid" >> $GITHUB_STEP_SUMMARY

      - name: Flake introspection
        run: |
          echo "## Flake Outputs" >> $GITHUB_STEP_SUMMARY
          nix flake show >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

      - name: Deadnix detection
        continue-on-error: true
        run: |
          echo "## Dead Code Detection" >> $GITHUB_STEP_SUMMARY
          nix shell nixpkgs#deadnix --command \
            deadnix --exclude result | tee /tmp/deadnix.log || true

          if [ -s /tmp/deadnix.log ]; then
            echo "‚ö†Ô∏è  Dead code found (see logs)" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚úÖ No dead code detected" >> $GITHUB_STEP_SUMMARY
          fi

  security:
    name: Security Scan
    runs-on: ubuntu-latest
    timeout-minutes: 10

    permissions:
      contents: read
      security-events: write

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: cachix/install-nix-action@v25
        with:
          nix_path: nixpkgs=channel:nixos-unstable

      - name: Gitleaks secret scan
        id: gitleaks
        continue-on-error: true
        run: |
          nix shell nixpkgs#gitleaks --command \
            gitleaks detect --source . --report-path gitleaks-report.json || true

      - name: Trivy filesystem scan
        id: trivy
        continue-on-error: true
        run: |
          nix shell nixpkgs#trivy --command \
            trivy fs --severity CRITICAL,HIGH --exit-code 0 .

      - name: Upload security reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: security-reports
          path: gitleaks-report.json
          if-no-files-found: ignore
          retention-days: 30

  documentation:
    name: Documentation Quality
    runs-on: ubuntu-latest
    timeout-minutes: 5

    permissions:
      contents: read

    steps:
      - uses: actions/checkout@v4

      - uses: cachix/install-nix-action@v25
        with:
          nix_path: nixpkgs=channel:nixos-unstable

      - name: Check markdown frontmatter
        continue-on-error: true
        run: |
          # Find all changed markdown files
          git fetch origin master --depth=1 2>/dev/null || true
          CHANGED_MD=$(git diff origin/master...HEAD --name-only -- '*.md' 2>/dev/null || git diff HEAD~1 --name-only -- '*.md' 2>/dev/null || echo "")

          if [ -z "$CHANGED_MD" ]; then
            echo "‚úÖ No markdown files changed"
            exit 0
          fi

          echo "Checking markdown files for YAML frontmatter..."
          MISSING_FRONTMATTER=0

          while IFS= read -r file; do
            if [ -z "$file" ] || [ ! -f "$file" ]; then
              continue
            fi

            # Skip auto-generated files and specific patterns
            if [[ "$file" =~ (CLAUDE\.md$|README\.md$|node_modules|\.devenv|\.claude/) ]]; then
              echo "  Skipped: $file (auto-generated)"
              continue
            fi

            # Check for frontmatter
            if ! head -1 "$file" | grep -q "^---$"; then
              echo "  ‚ùå Missing frontmatter: $file"
              MISSING_FRONTMATTER=1
            else
              echo "  ‚úÖ Valid: $file"
            fi
          done <<< "$CHANGED_MD"

          if [ $MISSING_FRONTMATTER -eq 1 ]; then
            echo ""
            echo "::warning::Some markdown files missing YAML frontmatter"
          else
            echo ""
            echo "‚úÖ All markdown files have valid frontmatter"
          fi

      - name: Markdown lint
        continue-on-error: true
        run: |
          if [ -d "docs" ] || ls *.md >/dev/null 2>&1; then
            nix shell nixpkgs#nodePackages.markdownlint-cli2 --command \
              markdownlint-cli2 "docs/**/*.md" "*.md" 2>/dev/null || \
              echo "‚ö†Ô∏è  Markdown linting complete (warnings allowed)"
          else
            echo "‚úÖ No markdown files to lint"
          fi

  validation-summary:
    name: Validation Summary
    runs-on: ubuntu-latest
    needs: [syntax, security, documentation]
    if: always()

    permissions:
      pull-requests: write

    steps:
      - name: Check syntax validation
        run: |
          if [ "${{ needs.syntax.result }}" != "success" ]; then
            echo "‚ùå Syntax validation failed"
            exit 1
          fi
          echo "‚úÖ Syntax validation passed"

      - name: Create validation report
        uses: actions/github-script@v7
        if: always() && github.event_name == 'pull_request'
        env:
          SYNTAX_RESULT: ${{ needs.syntax.result }}
          SECURITY_RESULT: ${{ needs.security.result }}
          DOCS_RESULT: ${{ needs.documentation.result }}
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const syntaxOk = process.env.SYNTAX_RESULT === 'success';
            const securityOk = process.env.SECURITY_RESULT === 'success';
            const docsOk = process.env.DOCS_RESULT === 'success';

            const comment = `## üîç Validation Results

| Check | Status |
|-------|--------|
| Syntax & Lint | ${syntaxOk ? '‚úÖ Pass' : '‚ùå Fail'} |
| Security Scan | ${securityOk ? '‚úÖ Pass' : '‚ö†Ô∏è  Review findings'} |
| Documentation | ${docsOk ? '‚úÖ Pass' : '‚ö†Ô∏è  Review'} |

**Ready to merge**: ${syntaxOk ? '‚úÖ **Yes**' : '‚ùå **No** - fix syntax errors first'}

---
<sub>Automated validation by GitHub Actions</sub>`;

            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            }).catch(err => {
              console.log('Failed to create comment:', err.message);
            });

