---
status: active
created: 2025-10-03
updated: 2025-10-08
type: architecture
lifecycle: persistent
---

# Claude Code Orchestration Architecture

**Three-Level Auto-Generation System for Enterprise NixOS Development**

> **üì¶ Note**: The claude-automation system was extracted to a separate repository on 2025-10-03.
> - **Repository**: https://github.com/jacopone/claude-nixos-automation
> - **Local Clone**: `~/claude-nixos-automation`
> - **Integration**: Via Nix flake input in `flake.nix`

## Overview

This NixOS configuration includes a **three-level Claude Code orchestration system** that automatically generates and maintains Claude configuration files across different scopes.

```
System-Wide          Project-Level        Template-Level
(~/.claude/)         (./CLAUDE.md)        (.ai-templates/claude/)
     ‚Üì                     ‚Üì                       ‚Üì
Auto-Generated       Auto-Generated         Manually Curated
On rebuild           On rebuild             High-quality source
162 tools            Workflows              Quality standards
```

---

## Three Levels Explained

### Level 1: System-Wide Configuration

**File**: `~/.claude/CLAUDE.md`
**Generated by**: `claude-nixos-automation` (external Nix flake)
**Triggered by**: Every `nixos-rebuild` via `./rebuild-nixos`
**Scope**: ALL Claude Code projects on this system

**Content**:
- Complete tool inventory (162 packages from `modules/core/packages.nix`)
- Fish shell abbreviations (57 abbreviations from `modules/home-manager/base.nix`)
- Tool substitution policies (fd > find, eza > ls, bat > cat, etc.)
- System information (NixOS version, desktop, shell)
- Command examples for modern CLI tools

**Purpose**: Ensures Claude always knows about all available system tools, regardless of which project you're working on.

**Example**:
```markdown
## Available Command Line Tools

### Development Tools
- `aider` - AI pair programming
- `ast-grep` - Structural search for code
- `devenv` - Fast declarative dev environments
- ... (162 total tools)

### Fish Shell Abbreviations
- `tree` ‚Üí `eza --tree`
- `lg` ‚Üí `eza -la --git --group-directories-first`
- ... (57 total abbreviations)
```

---

### Level 2: Project-Level Configuration

**File**: `./CLAUDE.md` (in nixos-config root)
**Generated by**: `claude-nixos-automation` (external Nix flake)
**Triggered by**: Every `nixos-rebuild` via `./rebuild-nixos`
**Scope**: Working on the nixos-config repository

**Content**:
- Tech stack (NixOS 25.11, Nix Flakes, Home Manager)
- Project structure (modules/, hosts/, templates/)
- Active workflows (rebuild process, AI orchestration, BASB system)
- Git status (current branch, uncommitted changes)
- Essential commands (rebuild, flake check, etc.)

**Purpose**: Provides context-specific information when Claude works on THIS repository.

**Example**:
```markdown
## Tech Stack
- **OS**: NixOS 25.11 with Nix Flakes
- **Desktop**: GNOME (Wayland)
- **Shell**: Fish with Starship prompt

## Project Structure
- `flake.nix` - Main configuration entry point
- `modules/core/packages.nix` - System-wide packages (162 tools)
- `templates/ai-quality-devenv/` - Enterprise dev template

## System Status
- **Git Status**: 0M 1A 0U
- **Last Updated**: 2025-10-01 14:08:14
```

---

### Level 3: Template-Level Configuration

**File**: Templates in `ai-project-orchestration` repository
**Maintained**: Manually (curated, high-quality)
**Triggered**: Never auto-generated (preserved across rebuilds)
**Scope**: New projects created via `ai-init-greenfield` or `ai-init-brownfield`

**Content**:
- Quality gate thresholds (CCN < 10, duplication < 5%, zero secrets)
- Quality gate compliance strategies with code examples
- DevEnv script documentation (quality-check, assess-codebase, etc.)
- MCP Serena integration patterns
- Testing requirements (75%+ coverage, AAA pattern)
- Technology stack integration (Node 20, Python 3.13, uv)

**Purpose**: Provides enterprise-grade quality standards and patterns for new projects.

**Example**:
```markdown
## Quality Gate Compliance Strategies

### Cyclomatic Complexity (CCN < 10)

**Before (CCN 15, FAILS)**:
```javascript
function processOrder(order) {
  if (order.type === 'express') {
    if (order.value > 100) {
      if (order.customer.isPremium) {
        // ... nested logic
      }
    }
  }
}
```

**After (CCN 3, PASSES)**:
```javascript
function processOrder(order) {
  const handler = getOrderHandler(order);
  return handler.process(order);
}
```
```

---

## The Auto-Generation Package

### Package: `scripts/claude-automation/`

**‚ö†Ô∏è CRITICAL INFRASTRUCTURE - DO NOT DELETE**

This is the engine that powers Levels 1 & 2 auto-generation.

**Directory structure**:
```
claude-automation/
‚îú‚îÄ‚îÄ README.md                    # Comprehensive documentation
‚îú‚îÄ‚îÄ .DO_NOT_DELETE               # Warning marker
‚îú‚îÄ‚îÄ generators/                  # CLAUDE.md generators
‚îÇ   ‚îú‚îÄ‚îÄ system_generator.py      # Level 1: System-wide
‚îÇ   ‚îî‚îÄ‚îÄ project_generator.py     # Level 2: Project-specific
‚îú‚îÄ‚îÄ parsers/
‚îÇ   ‚îî‚îÄ‚îÄ nix_parser.py           # Extracts data from .nix files
‚îú‚îÄ‚îÄ templates/
‚îÇ   ‚îú‚îÄ‚îÄ system-claude.j2         # Template for Level 1
‚îÇ   ‚îî‚îÄ‚îÄ project-claude.j2        # Template for Level 2
‚îî‚îÄ‚îÄ validators/
    ‚îî‚îÄ‚îÄ content_validator.py     # Validates generated files
```

**Why it exists**:
- Parses `modules/core/packages.nix` ‚Üí Extracts 162 tools
- Parses `modules/home-manager/base.nix` ‚Üí Extracts 57 fish abbreviations
- Generates `~/.claude/CLAUDE.md` (Level 1)
- Generates `./CLAUDE.md` (Level 2)

**Why it looks like a duplicate**:
- **Directory name**: `claude-automation/` (hyphenated)
- **Python import name**: `claude_automation` (underscored)
- This is **standard Python practice** - NOT a duplicate!

---

## Integration with rebuild-nixos

The `./rebuild-nixos` script orchestrates the auto-generation:

```bash
# In ./rebuild-nixos (after nixos-rebuild switch)

echo "üìã Updating Claude Code configurations..."

# Run automation from the claude-nixos-automation flake
if (cd ~/nixos-config && nix run github:jacopone/claude-nixos-automation#update-all); then
    echo "    ‚úÖ Claude Code configurations updated"
    echo "       - User policies: ~/.claude/CLAUDE-USER-POLICIES.md (preserved)"
    echo "       - System CLAUDE.md: ~/.claude/CLAUDE.md (updated)"
    echo "       - Project CLAUDE.md: ./CLAUDE.md (updated)"
else
    echo "    ‚ö†Ô∏è  Failed to update Claude configs (continuing anyway)"
fi
```

**Workflow**:
1. User runs `./rebuild-nixos`
2. NixOS configuration changes applied
3. Auto-generation scripts run
4. Claude configurations updated
5. User confirms changes
6. Changes committed to git

---

## Key Principles

### 1. No Duplication

Each level serves a distinct purpose:
- **Level 1**: Tools & CLI substitutions (system-wide context)
- **Level 2**: Workflows & structure (project-specific context)
- **Level 3**: Quality standards & patterns (template source)

### 2. Composition

When Claude Code works on a project, it reads:
- **Level 1** (always): System tools and capabilities
- **Level 2** (if exists): Project-specific workflows
- **Level 3** (if template-based): Quality standards

### 3. Auto vs Manual

- **Auto-generated** (Levels 1 & 2): Dynamic, reflects current state
- **Manually curated** (Level 3): High-quality, stable patterns

### 4. Preserved Template

Level 3 is **NEVER auto-generated**:
- Manually maintained for quality
- Copied to new projects via `init-ai-tools`
- Source of truth for quality standards
- Changes version-controlled in templates

---

## Workflow Examples

### Example 1: Adding a New System Tool

```bash
# 1. Add tool to packages.nix
nano modules/core/packages.nix
# Add: ripgrep-all

# 2. Rebuild system
./rebuild-nixos

# 3. Auto-generation runs
# ‚úÖ System-level Claude configuration updated
# ‚úÖ Project-level CLAUDE.md updated

# 4. Check results
cat ~/.claude/CLAUDE.md | grep "ripgrep-all"
# - `ripgrep-all` - Search in PDFs, E-Books, Office docs
```

**Result**: Claude immediately knows about the new tool in ALL projects.

---

### Example 2: Creating New Project from Template

```bash
# 1. Create project directory
mkdir ~/my-new-project
cd ~/my-new-project

# 2. Initialize with ai-project-orchestration
ai-init-greenfield
# Or: ai-init-brownfield for legacy projects

# 3. Activate environment
direnv allow

# 4. Files created
ls -la .claude/
# CLAUDE.md (from ai-project-orchestration template)
# settings.local.json
# README.md

# 5. Claude reads:
# - Level 1: ~/.claude/CLAUDE.md (system tools)
# - Level 3: .claude/CLAUDE.md (quality standards)
```

**Result**: New project has quality standards, Claude knows system tools.

---

### Example 3: Working on NixOS Config

```bash
# Claude Code session on nixos-config

# Claude reads:
# 1. Level 1: ~/.claude/CLAUDE.md
#    "You have 162 tools: aider, ast-grep, devenv..."
#
# 2. Level 2: ./CLAUDE.md
#    "This is NixOS config. Use ./rebuild-nixos to apply changes."
#    "Module structure: modules/core/, modules/home-manager/..."

# User: "Add a new package"
# Claude: Uses knowledge from Level 2 to know:
#   - Where to add: modules/core/packages.nix
#   - How to apply: ./rebuild-nixos
#   - Structure: existing package list format
```

---

## Maintenance

### Updating Level 1 (System-Wide)

**Automatic**: Runs on every `nixos-rebuild`

**Manual trigger**:
```bash
cd ~/nixos-config
nix run github:jacopone/claude-nixos-automation#update-system
```

**To modify template**:
```bash
cd ~/claude-nixos-automation
nano claude_automation/templates/system-claude.j2
```

---

### Updating Level 2 (Project-Level)

**Automatic**: Runs on every `nixos-rebuild`

**Manual trigger**:
```bash
cd ~/nixos-config
nix run github:jacopone/claude-nixos-automation#update-project
```

**To modify template**:
```bash
cd ~/claude-nixos-automation
nano claude_automation/templates/project-claude.j2
```

---

### Updating Level 3 (Template)

**Manual only**: Edit template source files in ai-project-orchestration repository

```bash
cd ~/ai-project-orchestration
nano templates/greenfield/.ai-templates/claude/CLAUDE.md
# Or: templates/brownfield/.ai-templates/claude/CLAUDE.md
```

**Changes apply**: When users run `ai-init-greenfield` or `ai-init-brownfield` in new projects

**Never auto-generated**: Preserves manual curation and quality

---

## Troubleshooting

### Issue: "Failed to update system-level Claude config"

**Check 1**: External repository accessible
```bash
ls -la ~/claude-nixos-automation/
# Should show: claude_automation/, flake.nix, *.py scripts
```

**Check 2**: Flake input configured
```bash
nix flake metadata ~/nixos-config | grep claude-automation
# Should show: claude-automation github:jacopone/claude-nixos-automation
```

**Check 3**: Manual trigger
```bash
cd ~/nixos-config
nix run github:jacopone/claude-nixos-automation#update-all
```

---

### Issue: Level 1 file missing

**Solution**: Regenerate manually
```bash
mkdir -p ~/.claude
cd ~/nixos-config
nix run github:jacopone/claude-nixos-automation#update-system
```

---

### Issue: Level 2 outdated after changes

**Solution**: Run rebuild-nixos or regenerate manually
```bash
./rebuild-nixos
# OR
cd ~/nixos-config
nix run github:jacopone/claude-nixos-automation#update-project
```

---

### Issue: Template (Level 3) was auto-deleted

**This should NEVER happen**: Level 3 is manually maintained.

If deleted in ai-project-orchestration repository:
```bash
# Restore from git
cd ~/ai-project-orchestration
git restore templates/greenfield/.ai-templates/claude/CLAUDE.md
```

---

## Why This Architecture?

### Problem Solved

**Before this system**:
- Claude didn't know about system tools
- Manual CLAUDE.md updates required
- Outdated configuration after package changes
- No separation between system/project/template concerns

**With this system**:
- ‚úÖ Auto-discovery of 162 system tools
- ‚úÖ Always up-to-date after rebuild
- ‚úÖ Clear separation of concerns
- ‚úÖ Template preservation
- ‚úÖ Zero manual maintenance for Levels 1 & 2

### Benefits

1. **Always Current**: Claude knows about tools immediately after installation
2. **Zero Maintenance**: Levels 1 & 2 auto-update
3. **High Quality**: Level 3 manually curated
4. **Composable**: Claude reads all relevant levels
5. **Scalable**: New projects inherit quality standards

---

## Related Documentation

- **claude-automation repository**: https://github.com/jacopone/claude-nixos-automation
- **claude-automation README**: `~/claude-nixos-automation/README.md`
- **System CLAUDE.md**: `~/.claude/CLAUDE.md` (auto-generated)
- **Project CLAUDE.md**: `./CLAUDE.md` (auto-generated)
- **User policies**: `~/.claude/CLAUDE-USER-POLICIES.md` (user-maintained)
- **Rebuild script**: `./rebuild-nixos`
- **Template system**: `ai-init-greenfield` / `ai-init-brownfield` commands

---

## Critical Reminders

### External Repository Integration

- ‚úÖ **claude-nixos-automation** is an external Nix flake
- ‚úÖ Integrated via `flake.nix` input
- ‚úÖ Powers auto-generation on every rebuild
- ‚úÖ Repository: https://github.com/jacopone/claude-nixos-automation
- ‚úÖ Local clone: `~/claude-nixos-automation`

### Package Location

- **External repo**: `~/claude-nixos-automation/` (outside nixos-config)
- **Nix flake input**: Referenced in `flake.nix`
- **No local scripts/**: Automation extracted to separate repository (2025-10-03)

### Manual vs Auto

- **Level 1 & 2**: Auto-generated (DO touch templates, DON'T edit generated files)
- **Level 3**: Manual (DO edit, version control, curate for quality)

---

**Architecture Version**: 2.1
**Last Updated**: 2025-10-06
**Status**: Production
**Orchestration**: Automatic via rebuild-nixos
**Automation**: External flake (github:jacopone/claude-nixos-automation)
